<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»Ÿé«”ç§Ÿå€Ÿç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.19.0/pocketbase.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .login-section {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .calendar-nav:hover {
            transform: scale(1.1);
        }

        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #ecf0f1;
            border-radius: 10px;
            padding: 10px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 60px;
            flex-direction: column;
            font-size: 14px;
        }

        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .calendar-day.weekend {
            background: #f8f9fa;
            color: #6c757d;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.occupied {
            color: white;
            font-weight: bold;
        }

        .day-number {
            font-weight: bold;
        }

        .unit-name {
            font-size: 10px;
            margin-top: 2px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #2c3e50;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .export-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .export-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
        }

        .notification.success {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }

        .notification.error {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .day-header {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
        }

        .reservations-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .reservation-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .reservation-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .hidden {
            display: none !important;
        }

        .timezone-info {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0c5460;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ è»Ÿé«”ç§Ÿå€Ÿç³»çµ±</h1>
        
        <!-- ç™»å…¥å€åŸŸ -->
        <div id="loginSection" class="login-section">
            <h2 style="text-align: center; margin-bottom: 20px;">ç³»çµ±ç™»å…¥</h2>
            
            <!-- ç™»å…¥è¡¨å–® -->
            <form id="loginForm">
                <div class="form-group">
                    <label>é›»å­éƒµä»¶</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                    <span id="loginBtnText">ç™»å…¥</span>
                    <span id="loginLoader" class="loading hidden"></span>
                </button>
            </form>
            
            <div style="text-align: center; margin: 20px 0; color: #666;">
                é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ
                <a href="#" onclick="showRegisterForm()" style="color: #667eea; text-decoration: none;">è¨»å†Šæ–°å¸³è™Ÿ</a>
            </div>
            
            <!-- è¨»å†Šè¡¨å–® -->
            <form id="registerForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">è¨»å†Šæ–°å¸³è™Ÿ</h3>
                <div class="form-group">
                    <label>é›»å­éƒµä»¶</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="registerPassword" minlength="8" required>
                </div>
                <div class="form-group">
                    <label>ç¢ºèªå¯†ç¢¼</label>
                    <input type="password" id="registerPasswordConfirm" minlength="8" required>
                </div>
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="registerName" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">
                    <span id="registerBtnText">è¨»å†Š</span>
                    <span id="registerLoader" class="loading hidden"></span>
                </button>
                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="showLoginForm()">
                    è¿”å›ç™»å…¥
                </button>
            </form>
        </div>

        <!-- ä¸»è¦ç³»çµ±å€åŸŸ -->
        <div id="mainSystem" class="hidden">
            <div class="timezone-info">
                â„¹ï¸ ç³»çµ±æ™‚å€å·²è¨­å®šç‚ºå°åŒ—æ™‚é–“ (UTC+8)ï¼Œæ‰€æœ‰æ—¥æœŸé¡¯ç¤ºå‡ç‚ºæœ¬åœ°æ™‚é–“
            </div>
            
            <!-- Debug è³‡è¨Š -->
            <div id="debugInfo" class="debug-info hidden">
                <div id="debugContent"></div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="openReservationModal()">ğŸ“… æ–°å¢é ç´„</button>
                <button class="btn btn-secondary" onclick="showReservationsList()">ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰é ç´„</button>
                <button class="btn btn-success" onclick="openExportModal()">ğŸ“Š åŒ¯å‡ºå ±è¡¨</button>
                <button class="btn btn-secondary btn-small" onclick="runDiagnostics()">ğŸ”§ ç³»çµ±è¨ºæ–·</button>
                <button class="btn btn-secondary btn-small" onclick="toggleDebugInfo()">ğŸ› é™¤éŒ¯è³‡è¨Š</button>
                <div class="user-info">
                    <span id="userEmail"></span>
                    <button class="btn btn-danger btn-small" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <div class="legend" id="legend">
                <span style="font-weight: bold;">åœ–ä¾‹ï¼š</span>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="previousMonth()">â€¹</button>
                    <div class="calendar-title" id="calendar-title"></div>
                    <button class="calendar-nav" onclick="nextMonth()">â€º</button>
                </div>
                <div class="calendar" id="calendar"></div>
            </div>

            <div class="export-section">
                <h3>ğŸ“Š åŒ¯å‡ºçµ±è¨ˆå ±è¡¨</h3>
                <div class="export-form">
                    <div class="form-group">
                        <label>èµ·å§‹æ—¥æœŸ</label>
                        <input type="date" id="export-start-date">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="date" id="export-end-date">
                    </div>
                    <button class="btn btn-success" onclick="exportToCSV()">åŒ¯å‡º CSV</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é ç´„æ¨¡æ…‹æ¡† -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">æ–°å¢é ç´„</h2>
                <span class="close" onclick="closeModal('reservationModal')">&times;</span>
            </div>
            <form id="reservationForm">
                <div class="form-group">
                    <label>å–®ä½åç¨± *</label>
                    <input type="text" id="unitName" required>
                </div>
                <div class="form-group">
                    <label>å°ˆæ¡ˆåç¨± *</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label>å§“å *</label>
                    <input type="text" id="contactName" required>
                </div>
                <div class="form-group">
                    <label>é€£çµ¡é›»è©± *</label>
                    <input type="tel" id="contactPhone" required>
                </div>
                <div class="form-group">
                    <label>æ•¸é‡ *</label>
                    <input type="number" id="quantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>é ç´„æ—¥æœŸ *</label>
                    <input type="date" id="startDate" required>
                </div>
                <div class="form-group">
                    <label>é è¨ˆçµæŸæ—¥æœŸ *</label>
                    <input type="date" id="endDate" required>
                </div>
                <div class="form-group">
                    <label>å¯¦éš›çµæŸæ—¥æœŸ</label>
                    <input type="date" id="actualEndDate">
                </div>
                <div class="form-group">
                    <label>ç‹€æ…‹</label>
                    <select id="status">
                        <option value="active">é€²è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('reservationModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submitBtnText">ç¢ºèªé ç´„</span>
                        <span id="submitLoader" class="loading hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- é ç´„åˆ—è¡¨æ¨¡æ…‹æ¡† -->
    <div id="reservationsListModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">æ‰€æœ‰é ç´„</h2>
                <span class="close" onclick="closeModal('reservationsListModal')">&times;</span>
            </div>
            <div class="reservations-list" id="reservationsList"></div>
        </div>
    </div>

    <!-- åŒ¯å‡ºæ¨¡æ…‹æ¡† -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åŒ¯å‡ºå ±è¡¨</h2>
                <span class="close" onclick="closeModal('exportModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>èµ·å§‹æ—¥æœŸ</label>
                <input type="date" id="modal-export-start-date">
            </div>
            <div class="form-group">
                <label>çµæŸæ—¥æœŸ</label>
                <input type="date" id="modal-export-end-date">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('exportModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="exportToCSV(true)">åŒ¯å‡º CSV</button>
            </div>
        </div>
    </div>

    <script>
        // PocketBase åˆå§‹åŒ–
        const pb = new PocketBase('http://192.168.200.132:8090');
        
        // =================== æ™‚å€è™•ç†å‡½æ•¸ ===================
        
        // å°‡å‰ç«¯çš„ YYYY-MM-DD æ ¼å¼è½‰æ›ç‚º PocketBase å„²å­˜æ ¼å¼ (ISO Date String)
        function frontendDateToPocketBase(frontendDateString) {
            if (!frontendDateString) {
                updateDebugInfo(`frontendDateToPocketBase: è¼¸å…¥ç‚ºç©º`);
                return null;
            }
            
            try {
                const [year, month, day] = frontendDateString.split('-').map(Number);
                if (isNaN(year) || isNaN(month) || isNaN(day)) {
                    updateDebugInfo(`frontendDateToPocketBase: ç„¡æ•ˆæ—¥æœŸæ ¼å¼: ${frontendDateString}`);
                    return null;
                }
                const localDate = new Date(year, month - 1, day, 0, 0, 0, 0);
                const isoString = localDate.toISOString();
                updateDebugInfo(`frontendDateToPocketBase: ${frontendDateString} â†’ ${isoString}`);
                return isoString;
            } catch (error) {
                updateDebugInfo(`frontendDateToPocketBase éŒ¯èª¤: ${frontendDateString} - ${error.message}`);
                return null;
            }
        }

        // å°‡ PocketBase çš„ UTC æ—¥æœŸå­—ä¸²è½‰ç‚ºå‰ç«¯ YYYY-MM-DD æ ¼å¼ï¼ˆAsia/Taipeiï¼‰
        function pocketBaseToFrontendDate(pocketBaseDateString) {
            if (!pocketBaseDateString) {
                updateDebugInfo(`ğŸ”„ pocketBaseToFrontendDate: è¼¸å…¥ç‚ºç©º`);
                return null;
            }
            
            updateDebugInfo(`ğŸ”„ pocketBaseToFrontendDate é–‹å§‹è½‰æ›: "${pocketBaseDateString}"`);
            
            try {
                const utcDate = new Date(pocketBaseDateString);
                if (isNaN(utcDate.getTime())) {
                    updateDebugInfo(`âŒ æ—¥æœŸè½‰æ›å¤±æ•—ï¼Œç„¡æ•ˆæ—¥æœŸ: "${pocketBaseDateString}"`);
                    return null;
                }
                
                // ä½¿ç”¨ toLocaleDateString è½‰ç‚º Asia/Taipei æ—¥æœŸ
                const localDateString = utcDate.toLocaleDateString('zh-TW', {
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '-'); // æ ¼å¼ç‚º YYYY-MM-DD
                
                updateDebugInfo(`âœ… æ—¥æœŸè½‰æ›æˆåŠŸ: "${pocketBaseDateString}" â†’ "${localDateString}"`);
                return localDateString;
            } catch (error) {
                updateDebugInfo(`âŒ pocketBaseToFrontendDate éŒ¯èª¤: ${pocketBaseDateString} - ${error.message}`);
                return null;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚ºé¡¯ç¤ºç”¨ï¼ˆYYYY/MM/DDï¼‰
        function formatDateForDisplay(frontendDateString) {
            if (!frontendDateString) return 'æœªè¨­å®š';
            
            const [year, month, day] = frontendDateString.split('-');
            return `${year}/${month}/${day}`;
        }

        // æ¯”è¼ƒå…©å€‹å‰ç«¯æ—¥æœŸå­—ä¸²
        function compareDates(date1, date2) {
            if (!date1 || !date2) return 0;
            return date1.localeCompare(date2);
        }

        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨ç¯„åœå…§
        function isDateInRange(checkDate, startDate, endDate) {
            return compareDates(checkDate, startDate) >= 0 && compareDates(checkDate, endDate) <= 0;
        }

        // å»ºç«‹æœ¬åœ°æ—¥æœŸç‰©ä»¶ï¼ˆç”¨æ–¼æ—¥æ›†è¨ˆç®—ï¼‰
        function createLocalDate(frontendDateString) {
            if (!frontendDateString) {
                updateDebugInfo(`createLocalDate: æ—¥æœŸç‚ºç©º`);
                return null;
            }
            
            try {
                const [year, month, day] = frontendDateString.split('-').map(Number);
                if (isNaN(year) || isNaN(month) || isNaN(day)) {
                    updateDebugInfo(`createLocalDate è§£æå¤±æ•—: ${frontendDateString}`);
                    return null;
                }
                const localDate = new Date(year, month - 1, day, 0, 0, 0, 0);
                updateDebugInfo(`createLocalDate: ${frontendDateString} â†’ ${localDate.toISOString()}`);
                return localDate;
            } catch (error) {
                updateDebugInfo(`createLocalDate éŒ¯èª¤: ${frontendDateString} - ${error.message}`);
                return null;
            }
        }

        // æ ¼å¼åŒ– Date ç‰©ä»¶ç‚ºå‰ç«¯æ—¥æœŸå­—ä¸²
        function formatDateToString(dateObj) {
            if (!dateObj || isNaN(dateObj.getTime())) {
                updateDebugInfo(`formatDateToString: ç„¡æ•ˆæ—¥æœŸç‰©ä»¶`);
                return null;
            }
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // =================== Debug åŠŸèƒ½ ===================
        let debugMessages = [];
        
        function updateDebugInfo(message) {
            debugMessages.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            // ä¿æŒæœ€å¤š 50 æ¢è¨˜éŒ„
            if (debugMessages.length > 50) {
                debugMessages = debugMessages.slice(-50);
            }
            
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = debugMessages.slice(-20).join('<br>');
            }
        }
        
        function toggleDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.classList.toggle('hidden');
        }
        
        // =================== ç³»çµ±è®Šæ•¸ ===================
        let offlineMode = false;
        let reservations = [];
        let currentDate = new Date();
        let currentEditingId = null;
        
        // å–®ä½é¡è‰²æ˜ å°„
        const unitColors = {};
        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
            '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3',
            '#ff9a9e', '#fecfef', '#fbc2eb', '#a6c1ee'
        ];
        let colorIndex = 0;

        // =================== åˆå§‹åŒ– ===================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é é¢è¼‰å…¥å®Œæˆ');
            updateDebugInfo('ç³»çµ±åˆå§‹åŒ–é–‹å§‹');
            
            // æ¸¬è©¦ PocketBase é€£ç·š
            const isConnected = await testConnection();
            
            if (offlineMode) {
                document.getElementById('userEmail').textContent = 'é›¢ç·šæ¨¡å¼';
                showMainSystem();
                loadReservationsOffline();
            } else {
                checkAuthStatus();
            }
        });

        // æ¸¬è©¦é€£ç·š
        async function testConnection() {
            try {
                const health = await pb.health.check();
                console.log('PocketBase é€£ç·šæ­£å¸¸');
                updateDebugInfo('PocketBase é€£ç·šæ­£å¸¸');
                offlineMode = false;
                return true;
            } catch (error) {
                console.error('PocketBase é€£ç·šå¤±æ•—:', error);
                updateDebugInfo(`PocketBase é€£ç·šå¤±æ•—: ${error.message}`);
                offlineMode = true;
                showNotification('ä½¿ç”¨é›¢ç·šæ¨¡å¼ï¼ˆè³‡æ–™å„²å­˜åœ¨ç€è¦½å™¨ä¸­ï¼‰', 'error');
                return false;
            }
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkAuthStatus() {
            console.log('æª¢æŸ¥ç™»å…¥ç‹€æ…‹:', pb.authStore.isValid);
            updateDebugInfo(`ç™»å…¥ç‹€æ…‹: ${pb.authStore.isValid ? 'å·²ç™»å…¥' : 'æœªç™»å…¥'}`);
            
            if (pb.authStore.isValid) {
                showMainSystem();
                loadReservations();
            } else {
                showLoginSection();
            }
        }

        // é¡¯ç¤ºç™»å…¥å€åŸŸ
        function showLoginSection() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
        }

        // é¡¯ç¤ºä¸»ç³»çµ±
        function showMainSystem() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            document.getElementById('userEmail').textContent = pb.authStore.model?.email || '';
            initCalendar();
        }

        // =================== ç™»å…¥åŠŸèƒ½ ===================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            updateDebugInfo(`å˜—è©¦ç™»å…¥: ${email}`);
            setLoginLoading(true);
            
            try {
                let authData = null;
                let loginSuccess = false;
                
                // å˜—è©¦ç®¡ç†å“¡ç™»å…¥
                if (!loginSuccess) {
                    try {
                        authData = await pb.collection('_superusers').authWithPassword(email, password);
                        updateDebugInfo('ç®¡ç†å“¡ç™»å…¥æˆåŠŸ');
                        loginSuccess = true;
                    } catch (adminError) {
                        updateDebugInfo(`ç®¡ç†å“¡ç™»å…¥å¤±æ•—: ${adminError.message}`);
                    }
                }
                
                // å˜—è©¦ä¸€èˆ¬ä½¿ç”¨è€…ç™»å…¥
                if (!loginSuccess) {
                    try {
                        authData = await pb.collection('users').authWithPassword(email, password);
                        updateDebugInfo('ä½¿ç”¨è€…ç™»å…¥æˆåŠŸ');
                        loginSuccess = true;
                    } catch (userError) {
                        updateDebugInfo(`ä½¿ç”¨è€…ç™»å…¥å¤±æ•—: ${userError.message}`);
                        throw userError;
                    }
                }
                
                if (loginSuccess) {
                    showNotification('ç™»å…¥æˆåŠŸï¼');
                    showMainSystem();
                    await loadReservations();
                }
                
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                updateDebugInfo(`ç™»å…¥éŒ¯èª¤: ${error.message}`);
                
                let errorMessage = 'ç™»å…¥å¤±æ•—';
                if (error.status === 400) {
                    errorMessage = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
                } else if (error.status === 0) {
                    errorMessage = 'ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹ç¢ºèª PocketBase å·²å•Ÿå‹•';
                } else {
                    errorMessage = error.message || 'è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼';
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                setLoginLoading(false);
            }
        });

        // è¨»å†Šè¡¨å–®è™•ç†
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const name = document.getElementById('registerName').value;
            
            if (password !== passwordConfirm) {
                showNotification('å¯†ç¢¼ç¢ºèªä¸ç¬¦ï¼', 'error');
                return;
            }
            
            setRegisterLoading(true);
            
            try {
                const data = {
                    email: email,
                    password: password,
                    passwordConfirm: passwordConfirm,
                    name: name
                };
                
                await pb.collection('users').create(data);
                updateDebugInfo(`è¨»å†ŠæˆåŠŸ: ${email}`);
                showNotification('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥ä½¿ç”¨ç³»çµ±ã€‚');
                showLoginForm();
            } catch (error) {
                console.error('Register error:', error);
                updateDebugInfo(`è¨»å†ŠéŒ¯èª¤: ${error.message}`);
                showNotification('è¨»å†Šå¤±æ•—ï¼š' + (error.message || 'è«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™'), 'error');
            } finally {
                setRegisterLoading(false);
            }
        });

        // é¡¯ç¤ºè¨»å†Šè¡¨å–®
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        // é¡¯ç¤ºç™»å…¥è¡¨å–®
        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        // è¨­ç½®è¼‰å…¥ç‹€æ…‹
        function setRegisterLoading(loading) {
            const btnText = document.getElementById('registerBtnText');
            const loader = document.getElementById('registerLoader');
            
            if (loading) {
                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function setLoginLoading(loading) {
            const btnText = document.getElementById('loginBtnText');
            const loader = document.getElementById('loginLoader');
            
            if (loading) {
                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        // ç™»å‡º
        function logout() {
            pb.authStore.clear();
            showLoginSection();
            reservations = [];
            updateDebugInfo('ä½¿ç”¨è€…ç™»å‡º');
            showNotification('å·²ç™»å‡º');
        }

        // =================== è³‡æ–™è¼‰å…¥ ===================
        async function loadReservations() {
            if (offlineMode) {
                loadReservationsOffline();
                return;
            }
            
            try {
                updateDebugInfo('=== ğŸ”„ é–‹å§‹è¼‰å…¥é ç´„è³‡æ–™ ===');
                const records = await pb.collection('reservations').getFullList({
                    sort: 'start_date',
                    filter: 'status != "cancelled"' // åƒ…è¼‰å…¥éå–æ¶ˆé ç´„
                });
                
                updateDebugInfo(`ğŸ“¥ å¾è³‡æ–™åº«è¼‰å…¥äº† ${records.length} ç­†åŸå§‹è³‡æ–™`);
                
                reservations = [];
                
                for (let i = 0; i < records.length; i++) {
                    const record = records[i];
                    updateDebugInfo(`=== è™•ç†ç¬¬ ${i + 1} ç­†è³‡æ–™ ===`);
                    updateDebugInfo(`ğŸ“‹ åŸå§‹è³‡æ–™ ID: ${record.id}`);
                    updateDebugInfo(`ğŸ“… åŸå§‹ start_date: "${record.start_date}"`);
                    updateDebugInfo(`ğŸ“… åŸå§‹ end_date: "${record.end_date}"`);
                    if (record.actual_end_date) {
                        updateDebugInfo(`ğŸ“… åŸå§‹ actual_end_date: "${record.actual_end_date}"`);
                    }
                    
                    const convertedStart = pocketBaseToFrontendDate(record.start_date);
                    const convertedEnd = pocketBaseToFrontendDate(record.end_date);
                    const convertedActual = record.actual_end_date ? pocketBaseToFrontendDate(record.actual_end_date) : null;
                    
                    if (!convertedStart || !convertedEnd) {
                        updateDebugInfo(`âš ï¸ è­¦å‘Šï¼šé ç´„ ${record.id} æ—¥æœŸè½‰æ›å¤±æ•—ï¼Œè·³éæ­¤ç­†è³‡æ–™`);
                        continue;
                    }
                    
                    const converted = {
                        id: record.id,
                        unitName: record.unit_name,
                        projectName: record.project_name,
                        contactName: record.contact_name,
                        contactPhone: record.contact_phone,
                        quantity: record.quantity,
                        startDate: convertedStart,
                        endDate: convertedEnd,
                        actualEndDate: convertedActual,
                        status: record.status,
                        created: record.created,
                        updated: record.updated
                    };
                    
                    updateDebugInfo(`ğŸ“ æœ€çµ‚ç‰©ä»¶ startDate: "${converted.startDate}"`);
                    updateDebugInfo(`ğŸ“ æœ€çµ‚ç‰©ä»¶ endDate: "${converted.endDate}"`);
                    if (converted.actualEndDate) {
                        updateDebugInfo(`ğŸ“ æœ€çµ‚ç‰©ä»¶ actualEndDate: "${converted.actualEndDate}"`);
                    }
                    
                    reservations.push(converted);
                    updateDebugInfo(`âœ… æˆåŠŸåŠ å…¥é ç´„: ${converted.unitName} ${converted.startDate} ~ ${converted.endDate}`);
                }
                
                updateDebugInfo(`=== âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼ŒæˆåŠŸè™•ç† ${reservations.length} ç­†é ç´„ ===`);
                
                renderCalendar();
                updateLegend();
                showReservationsList(); // è‡ªå‹•æ›´æ–°é ç´„åˆ—è¡¨
            } catch (error) {
                console.error('Error loading reservations:', error);
                updateDebugInfo(`âŒ è¼‰å…¥è³‡æ–™å¤±æ•—: ${error.message}`);
                showNotification('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨é€£ç·š', 'error');
            }
        }
        
        // è¼‰å…¥é›¢ç·šè³‡æ–™
        function loadReservationsOffline() {
            try {
                const saved = localStorage.getItem('reservations');
                reservations = saved ? JSON.parse(saved) : [];
                updateDebugInfo(`é›¢ç·šæ¨¡å¼è¼‰å…¥äº† ${reservations.length} ç­†é ç´„`);
                renderCalendar();
                updateLegend();
            } catch (error) {
                console.error('Error loading offline reservations:', error);
                updateDebugInfo(`é›¢ç·šè¼‰å…¥å¤±æ•—: ${error.message}`);
                reservations = [];
            }
        }

        // å„²å­˜é›¢ç·šè³‡æ–™
        function saveReservationsOffline() {
            try {
                localStorage.setItem('reservations', JSON.stringify(reservations));
                updateDebugInfo('é›¢ç·šè³‡æ–™å·²å„²å­˜');
            } catch (error) {
                console.error('Error saving offline reservations:', error);
                updateDebugInfo(`é›¢ç·šå„²å­˜å¤±æ•—: ${error.message}`);
            }
        }

        // =================== æ—¥æ›†åŠŸèƒ½ ===================
        function getUnitColor(unitName) {
            if (!unitColors[unitName]) {
                unitColors[unitName] = colors[colorIndex % colors.length];
                colorIndex++;
            }
            return unitColors[unitName];
        }

        function updateLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '<span style="font-weight: bold;">åœ–ä¾‹ï¼š</span>';
            
            Object.entries(unitColors).forEach(([unit, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${color};"></div>
                    <span>${unit}</span>
                `;
                legend.appendChild(item);
            });
        }

        function initCalendar() {
            renderCalendar();
            updateLegend();
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const title = document.getElementById('calendar-title');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            title.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            calendar.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // æ¸²æŸ“æ—¥æœŸ
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰æœˆä»½
                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                }
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºé€±æœ«
                if (cellDate.getDay() === 0 || cellDate.getDay() === 6) {
                    dayCell.classList.add('weekend');
                }
                
                // æª¢æŸ¥é ç´„ç‹€æ³
                const dateStr = formatDateToString(cellDate);
                const reservation = getReservationForDate(dateStr);
                
                if (reservation) {
                    dayCell.classList.add('occupied');
                    dayCell.style.background = getUnitColor(reservation.unitName);
                    
                    const unitName = document.createElement('div');
                    unitName.className = 'unit-name';
                    unitName.textContent = reservation.unitName;
                    dayCell.appendChild(unitName);
                }
                
                dayCell.addEventListener('click', () => handleDateClick(dateStr, reservation));
                calendar.appendChild(dayCell);
            }
            
            updateDebugInfo(`æ—¥æ›†æ¸²æŸ“å®Œæˆ: ${year}/${month + 1}`);
        }

        function getReservationForDate(dateStr) {
            return reservations.find(reservation => {
                if (reservation.status === 'cancelled') return false;
                
                const endDate = reservation.actualEndDate || reservation.endDate;
                return isDateInRange(dateStr, reservation.startDate, endDate);
            });
        }

        function handleDateClick(dateStr, reservation) {
            if (reservation) {
                showReservationDetails(reservation);
            } else {
                openReservationModal(dateStr);
            }
        }

        // =================== é ç´„è©³æƒ…é¡¯ç¤º ===================
        function showReservationDetails(reservation) {
            updateDebugInfo(`=== ğŸ“‹ é¡¯ç¤ºé ç´„è©³æƒ… ===`);
            updateDebugInfo(`ğŸ” reservation ç‰©ä»¶æª¢æŸ¥:`);
            updateDebugInfo(`  - id: ${reservation.id}`);
            updateDebugInfo(`  - unitName: ${reservation.unitName}`);
            updateDebugInfo(`  - startDate: "${reservation.startDate}" (é¡å‹: ${typeof reservation.startDate})`);
            updateDebugInfo(`  - endDate: "${reservation.endDate}" (é¡å‹: ${typeof reservation.endDate})`);
            updateDebugInfo(`  - actualEndDate: "${reservation.actualEndDate}" (é¡å‹: ${typeof reservation.actualEndDate})`);
            
            const startDate = reservation.startDate;
            const endDate = reservation.endDate;
            const actualEndDate = reservation.actualEndDate;
            
            const actualDays = calculateActualDays(startDate, actualEndDate || endDate);
            updateDebugInfo(`ğŸ“Š è¨ˆç®—çµæœ: ${actualDays} å¤©`);
            
            const displayStart = formatDateForDisplay(startDate);
            const displayEnd = formatDateForDisplay(endDate);
            const displayActual = actualEndDate ? formatDateForDisplay(actualEndDate) : 'é€²è¡Œä¸­';
            
            updateDebugInfo(`ğŸ¨ æ ¼å¼åŒ–é¡¯ç¤º: ${displayStart} ~ ${displayEnd}, å¯¦éš›: ${displayActual}`);
            
            if (confirm(`é ç´„è©³æƒ…ï¼š
å–®ä½ï¼š${reservation.unitName}
å°ˆæ¡ˆï¼š${reservation.projectName}
è¯çµ¡äººï¼š${reservation.contactName}
é›»è©±ï¼š${reservation.contactPhone}
æ•¸é‡ï¼š${reservation.quantity}
é ç´„æœŸé–“ï¼š${displayStart} ~ ${displayEnd}
å¯¦éš›çµæŸï¼š${displayActual}
ç‹€æ…‹ï¼š${getStatusText(reservation.status)}
å¯¦éš›ä½¿ç”¨å¤©æ•¸ï¼š${actualDays} å¤©

æ˜¯å¦è¦ç·¨è¼¯æ­¤é ç´„ï¼Ÿ`)) {
                editReservation(reservation);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'active': 'é€²è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        function editReservation(reservation) {
            currentEditingId = reservation.id;
            
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯é ç´„';
            document.getElementById('unitName').value = reservation.unitName;
            document.getElementById('projectName').value = reservation.projectName;
            document.getElementById('contactName').value = reservation.contactName;
            document.getElementById('contactPhone').value = reservation.contactPhone;
            document.getElementById('quantity').value = reservation.quantity;
            document.getElementById('startDate').value = reservation.startDate;
            document.getElementById('endDate').value = reservation.endDate;
            document.getElementById('actualEndDate').value = reservation.actualEndDate || '';
            document.getElementById('status').value = reservation.status || 'active';
            
            updateDebugInfo(`ç·¨è¼¯é ç´„ ${reservation.id}: ${reservation.startDate} ~ ${reservation.endDate}`);
            document.getElementById('reservationModal').style.display = 'block';
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function openReservationModal(selectedDate = null) {
            currentEditingId = null;
            document.getElementById('modal-title').textContent = 'æ–°å¢é ç´„';
            document.getElementById('reservationForm').reset();
            
            if (selectedDate) {
                document.getElementById('startDate').value = selectedDate;
                updateDebugInfo(`é–‹å•Ÿæ–°å¢é ç´„è¦–çª—ï¼Œé è¨­æ—¥æœŸ: ${selectedDate}`);
            }
            
            document.getElementById('reservationModal').style.display = 'block';
        }

        function openExportModal() {
            document.getElementById('exportModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // =================== é ç´„è¡¨å–®è™•ç† ===================
        document.getElementById('reservationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                unitName: document.getElementById('unitName').value,
                projectName: document.getElementById('projectName').value,
                contactName: document.getElementById('contactName').value,
                contactPhone: document.getElementById('contactPhone').value,
                quantity: parseInt(document.getElementById('quantity').value),
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                actualEndDate: document.getElementById('actualEndDate').value || null,
                status: document.getElementById('status').value || 'active'
            };
            
            updateDebugInfo(`æäº¤é ç´„è¡¨å–®: ${formData.unitName} ${formData.startDate} ~ ${formData.endDate}`);
            
            // æª¢æŸ¥æ—¥æœŸè¡çª
            if (!currentEditingId && hasDateConflict(formData.startDate, formData.endDate)) {
                showNotification('é¸æ“‡çš„æ—¥æœŸå·²è¢«é ç´„ï¼', 'error');
                return;
            }
            
            setSubmitLoading(true);
            
            try {
                if (currentEditingId) {
                    // æ›´æ–°ç¾æœ‰é ç´„
                    if (offlineMode) {
                        const index = reservations.findIndex(r => r.id === currentEditingId);
                        if (index !== -1) {
                            reservations[index] = { ...reservations[index], ...formData };
                        }
                        saveReservationsOffline();
                        updateDebugInfo(`é›¢ç·šæ›´æ–°é ç´„ ${currentEditingId}`);
                    } else {
                        const data = {
                            unit_name: formData.unitName,
                            project_name: formData.projectName,
                            contact_name: formData.contactName,
                            contact_phone: formData.contactPhone,
                            quantity: formData.quantity,
                            start_date: frontendDateToPocketBase(formData.startDate),
                            end_date: frontendDateToPocketBase(formData.endDate),
                            actual_end_date: formData.actualEndDate ? frontendDateToPocketBase(formData.actualEndDate) : null,
                            status: formData.status
                        };
                        
                        updateDebugInfo(`æ›´æ–°é ç´„åˆ°è³‡æ–™åº«: ${data.start_date} ~ ${data.end_date}`);
                        await pb.collection('reservations').update(currentEditingId, data);
                        await loadReservations();
                    }
                    showNotification('é ç´„å·²æ›´æ–°ï¼');
                } else {
                    // æ–°å¢é ç´„
                    if (offlineMode) {
                        formData.id = Date.now().toString();
                        formData.created = new Date().toISOString();
                        reservations.push(formData);
                        saveReservationsOffline();
                        updateDebugInfo(`é›¢ç·šæ–°å¢é ç´„: ${formData.unitName}`);
                    } else {
                        const data = {
                            unit_name: formData.unitName,
                            project_name: formData.projectName,
                            contact_name: formData.contactName,
                            contact_phone: formData.contactPhone,
                            quantity: formData.quantity,
                            start_date: frontendDateToPocketBase(formData.startDate),
                            end_date: frontendDateToPocketBase(formData.endDate),
                            actual_end_date: formData.actualEndDate ? frontendDateToPocketBase(formData.actualEndDate) : null,
                            status: formData.status
                        };
                        
                        updateDebugInfo(`æ–°å¢é ç´„åˆ°è³‡æ–™åº«: ${data.start_date} ~ ${data.end_date}`);
                        await pb.collection('reservations').create(data);
                        await loadReservations();
                    }
                    showNotification('é ç´„å·²å»ºç«‹ï¼');
                }
                
                renderCalendar();
                closeModal('reservationModal');
            } catch (error) {
                console.error('Error saving reservation:', error);
                updateDebugInfo(`å„²å­˜é ç´„å¤±æ•—: ${error.message}`);
                showNotification('å„²å­˜å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            } finally {
                setSubmitLoading(false);
            }
        });

        function setSubmitLoading(loading) {
            const btnText = document.getElementById('submitBtnText');
            const loader = document.getElementById('submitLoader');
            
            if (loading) {
                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function hasDateConflict(startDate, endDate) {
            return reservations.some(reservation => {
                if (currentEditingId && reservation.id === currentEditingId) return false;
                if (reservation.status === 'cancelled') return false;
                
                const resEndDate = reservation.actualEndDate || reservation.endDate;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡ç–Š
                return compareDates(startDate, resEndDate) <= 0 && compareDates(endDate, reservation.startDate) >= 0;
            });
        }

        // =================== é ç´„åˆ—è¡¨ ===================
        function showReservationsList() {
            const list = document.getElementById('reservationsList');
            list.innerHTML = '';
            
            const sortedReservations = [...reservations].sort((a, b) => compareDates(a.startDate, b.startDate));
            
            updateDebugInfo(`é¡¯ç¤ºé ç´„åˆ—è¡¨: ${sortedReservations.length} ç­†é ç´„`);
            
            if (sortedReservations.length === 0) {
                updateDebugInfo(`âš ï¸ ç„¡é ç´„è³‡æ–™å¯é¡¯ç¤º`);
                list.innerHTML = '<p>ç„¡é ç´„è³‡æ–™</p>';
                document.getElementById('reservationsListModal').style.display = 'block';
                return;
            }
            
            sortedReservations.forEach((reservation, index) => {
                const item = document.createElement('div');
                item.className = 'reservation-item';
                
                const startDate = reservation.startDate;
                const endDate = reservation.endDate;
                const actualEndDate = reservation.actualEndDate;
                
                const actualDays = calculateActualDays(startDate, actualEndDate || endDate);
                updateDebugInfo(`åˆ—è¡¨é …ç›® ${index + 1}: ${reservation.unitName} ${startDate} ~ ${endDate}, å¯¦éš›å¤©æ•¸: ${actualDays}`);
                
                item.innerHTML = `
                    <div class="reservation-actions">
                        <button class="btn btn-primary btn-small" onclick="editReservationFromList('${reservation.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-secondary btn-small" onclick="deleteReservation('${reservation.id}')">åˆªé™¤</button>
                    </div>
                    <strong>${reservation.unitName}</strong> - ${reservation.projectName}<br>
                    è¯çµ¡äººï¼š${reservation.contactName} (${reservation.contactPhone})<br>
                    æ•¸é‡ï¼š${reservation.quantity}<br>
                    é ç´„æœŸé–“ï¼š${formatDateForDisplay(startDate)} ~ ${formatDateForDisplay(endDate)}<br>
                    å¯¦éš›çµæŸï¼š${actualEndDate ? formatDateForDisplay(actualEndDate) : 'é€²è¡Œä¸­'}<br>
                    ç‹€æ…‹ï¼š${getStatusText(reservation.status)}<br>
                    å¯¦éš›ä½¿ç”¨å¤©æ•¸ï¼š${actualDays} å¤©
                `;
                
                list.appendChild(item);
            });
            
            document.getElementById('reservationsListModal').style.display = 'block';
        }

        function editReservationFromList(id) {
            const reservation = reservations.find(r => r.id === id);
            if (reservation) {
                closeModal('reservationsListModal');
                editReservation(reservation);
            }
        }

        async function deleteReservation(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é ç´„å—ï¼Ÿ')) return;
            
            try {
                if (offlineMode) {
                    reservations = reservations.filter(r => r.id !== id);
                    saveReservationsOffline();
                    updateDebugInfo(`é›¢ç·šåˆªé™¤é ç´„ ${id}`);
                } else {
                    await pb.collection('reservations').delete(id);
                    updateDebugInfo(`å¾è³‡æ–™åº«åˆªé™¤é ç´„ ${id}`);
                    await loadReservations();
                }
                
                renderCalendar();
                showReservationsList();
                showNotification('é ç´„å·²åˆªé™¤ï¼');
            } catch (error) {
                console.error('Error deleting reservation:', error);
                updateDebugInfo(`åˆªé™¤é ç´„å¤±æ•—: ${error.message}`);
                showNotification('åˆªé™¤å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            }
        }

        // =================== å·¥å…·å‡½æ•¸ ===================
        function calculateActualDays(startDate, endDate) {
            if (!startDate || !endDate) {
                updateDebugInfo(`calculateActualDays: æ—¥æœŸåƒæ•¸ç‚ºç©º - start: ${startDate}, end: ${endDate}`);
                return 0;
            }
            
            updateDebugInfo(`ğŸ§® è¨ˆç®—å¯¦éš›å¤©æ•¸: "${startDate}" ~ "${endDate}"`);
            
            const start = createLocalDate(startDate);
            const end = createLocalDate(endDate);
            
            if (!start || !end || start > end) {
                updateDebugInfo(`âŒ æ—¥æœŸç„¡æ•ˆæˆ–èµ·å§‹æ—¥æœŸæ™šæ–¼çµæŸæ—¥æœŸ`);
                return 0;
            }
            
            let days = 0;
            let currentDate = new Date(start);
            
            while (currentDate <= end) {
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) { // æ’é™¤é€±æœ«
                    days++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            updateDebugInfo(`âœ… è¨ˆç®—çµæœ: ${days} å¤© (${startDate} ~ ${endDate})`);
            return days;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // =================== åŒ¯å‡ºåŠŸèƒ½ ===================
        function exportToCSV(useModal = false) {
            const startDateInput = useModal ? 'modal-export-start-date' : 'export-start-date';
            const endDateInput = useModal ? 'modal-export-end-date' : 'export-end-date';
            
            const startDate = document.getElementById(startDateInput).value;
            const endDate = document.getElementById(endDateInput).value;
            
            if (!startDate || !endDate) {
                showNotification('è«‹é¸æ“‡èµ·è¨–æ—¥æœŸï¼', 'error');
                return;
            }
            
            updateDebugInfo(`åŒ¯å‡º CSV: ${startDate} ~ ${endDate}`);
            
            const filteredReservations = reservations.filter(reservation => {
                const resEndDate = reservation.actualEndDate || reservation.endDate;
                
                // æª¢æŸ¥é ç´„æœŸé–“æ˜¯å¦èˆ‡ç¯©é¸æœŸé–“æœ‰é‡ç–Š
                return compareDates(reservation.startDate, endDate) <= 0 && compareDates(resEndDate, startDate) >= 0;
            });
            
            const csvData = [];
            csvData.push(['å–®ä½åç¨±', 'å°ˆæ¡ˆåç¨±', 'çµ±è¨ˆæœŸé–“æ•¸é‡ç¸½è¨ˆ', 'çµ±è¨ˆæœŸé–“å¯¦éš›ä½¿ç”¨å¤©æ•¸']);
            
            const summary = {};
            filteredReservations.forEach(reservation => {
                const key = `${reservation.unitName}-${reservation.projectName}`;
                if (!summary[key]) {
                    summary[key] = {
                        unitName: reservation.unitName,
                        projectName: reservation.projectName,
                        totalQuantity: 0,
                        totalDays: 0
                    };
                }
                
                summary[key].totalQuantity += reservation.quantity;
                
                // è¨ˆç®—é‡ç–ŠæœŸé–“çš„å¤©æ•¸
                const overlapStart = compareDates(reservation.startDate, startDate) >= 0 ? reservation.startDate : startDate;
                const overlapEnd = compareDates(reservation.actualEndDate || reservation.endDate, endDate) <= 0 ? 
                    (reservation.actualEndDate || reservation.endDate) : endDate;
                
                if (compareDates(overlapStart, overlapEnd) <= 0) {
                    const days = calculateActualDays(overlapStart, overlapEnd);
                    summary[key].totalDays += days;
                    updateDebugInfo(`CSV è¨ˆç®—: ${reservation.unitName} ${overlapStart} ~ ${overlapEnd} = ${days} å¤©`);
                }
            });
            
            Object.values(summary).forEach(item => {
                csvData.push([item.unitName, item.projectName, item.totalQuantity, item.totalDays]);
            });
            
            // è½‰æ›ç‚º CSV æ ¼å¼
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `è»Ÿé«”ç§Ÿå€Ÿçµ±è¨ˆ_${startDate}_${endDate}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            if (useModal) {
                closeModal('exportModal');
            }
            
            updateDebugInfo(`CSV åŒ¯å‡ºå®Œæˆ: ${Object.keys(summary).length} é …ç›®`);
            showNotification('CSV æª”æ¡ˆå·²åŒ¯å‡ºï¼');
        }

        // =================== è¨ºæ–·åŠŸèƒ½ ===================
        async function runDiagnostics() {
            console.log('=== é–‹å§‹ç³»çµ±è¨ºæ–· ===');
            updateDebugInfo('ğŸ”§ é–‹å§‹ç³»çµ±è¨ºæ–·');
            
            try {
                // 1. æ¸¬è©¦åŸºæœ¬é€£ç·š
                console.log('1. æ¸¬è©¦ PocketBase åŸºæœ¬é€£ç·š...');
                const response = await fetch('http://192.168.200.132:8090/api/health');
                if (response.ok) {
                    console.log('âœ… PocketBase é€£ç·šæ­£å¸¸');
                    updateDebugInfo('âœ… PocketBase é€£ç·šæ­£å¸¸');
                } else {
                    console.log('âŒ PocketBase é€£ç·šç•°å¸¸', response.status);
                    updateDebugInfo(`âŒ PocketBase é€£ç·šç•°å¸¸: ${response.status}`);
                }
                
                // 2. æ™‚å€è½‰æ›æ¸¬è©¦
                console.log('2. æ™‚å€è½‰æ›æ¸¬è©¦...');
                const testDate = '2024-01-15';
                const toPB = frontendDateToPocketBase(testDate);
                const fromPB = pocketBaseToFrontendDate(toPB);
                console.log(`æ¸¬è©¦æ—¥æœŸ: ${testDate} â†’ PB: ${toPB} â†’ å‰ç«¯: ${fromPB}`);
                updateDebugInfo(`ğŸ§ª æ™‚å€è½‰æ›æ¸¬è©¦: ${testDate} â†’ ${toPB} â†’ ${fromPB}`);
                
                // 3. æª¢æŸ¥ç¾æœ‰è³‡æ–™çš„è½‰æ›
                if (reservations.length > 0) {
                    console.log('3. æª¢æŸ¥ç¾æœ‰é ç´„è³‡æ–™...');
                    reservations.slice(0, 3).forEach((res, index) => {
                        console.log(`é ç´„ ${index + 1}: ${res.unitName} ${res.startDate} ~ ${res.endDate}`);
                        updateDebugInfo(`ğŸ“‹ é ç´„ ${index + 1}: ${res.unitName} ${res.startDate} ~ ${res.endDate}`);
                    });
                }
                
                // 4. æ—¥æ›†é¡¯ç¤ºæ¸¬è©¦
                console.log('4. æ—¥æ›†é¡¯ç¤ºæ¸¬è©¦...');
                const today = formatDateToString(new Date());
                console.log(`ä»Šå¤©æ—¥æœŸ: ${today}`);
                updateDebugInfo(`ğŸ“… ä»Šå¤©æ—¥æœŸ: ${today}`);
                
                // 5. å¤©æ•¸è¨ˆç®—æ¸¬è©¦
                console.log('5. å¤©æ•¸è¨ˆç®—æ¸¬è©¦...');
                if (reservations.length > 0) {
                    const testRes = reservations[0];
                    const days = calculateActualDays(testRes.startDate, testRes.actualEndDate || testRes.endDate);
                    console.log(`æ¸¬è©¦å¤©æ•¸è¨ˆç®—: ${testRes.startDate} ~ ${testRes.actualEndDate || testRes.endDate} = ${days} å¤©`);
                    updateDebugInfo(`ğŸ§® æ¸¬è©¦å¤©æ•¸è¨ˆç®—: ${testRes.startDate} ~ ${testRes.actualEndDate || testRes.endDate} = ${days} å¤©`);
                }
                
                alert('è¨ºæ–·å®Œæˆï¼è«‹æŸ¥çœ‹æ§åˆ¶å°å’Œé™¤éŒ¯è³‡è¨Šç²å¾—è©³ç´°è³‡è¨Šã€‚');
                
            } catch (error) {
                console.error('è¨ºæ–·éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                updateDebugInfo(`âŒ è¨ºæ–·éŒ¯èª¤: ${error.message}`);
                alert('è¨ºæ–·å¤±æ•—ï¼š' + error.message);
            }
            
            console.log('=== è¨ºæ–·çµæŸ ===');
        }
    </script>
</body>
</html>